{% extends "base.html" %}

{% block title %}Device Tracking - Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 style="color: white;"><i class="fas fa-laptop-house"></i> Device Management</h1>
        <p style="color: white;" class="lead">Configure and manage employee devices</p>
    </div>
</div>

<!-- Dashboard Overview Cards -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ saved_devices|length }}</h4>
                        <p class="card-text">Total Devices</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-laptop fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ active_count|default(0) }}</h4>
                        <p class="card-text">Active Devices</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-signal fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ online_count|default(0) }}</h4>
                        <p class="card-text">Online Now</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-wifi fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">
                            <a href="{{ url_for('tracking_bp.live_tracking') }}"
                                class="text-white text-decoration-none">
                                <i class="fas fa-external-link-alt"></i> Go Live
                            </a>
                        </h4>
                        <p class="card-text">Live Tracking</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Scanner Section -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="row w-100 m-0">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="fas fa-satellite-dish"></i> Network Scanner</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary" id="trackingScanBtn">
                            <i class="fas fa-search"></i> Scan Network
                        </button>
                        <button class="btn btn-info" id="syncBtn">
                            <i class="fas fa-sync-alt"></i> Sync IPs
                        </button>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                            <i class="fas fa-plus"></i> Add Manual
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="scanResults">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>Click "Scan Network" to discover devices with port 5002 open</p>
                        <small class="text-muted">Scans for devices with port 5002 open (your tracking service)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Device Management Section -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-laptop"></i> Device Management</h5>
                <div>
                    <a href="{{ url_for('tracking_bp.live_tracking') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-chart-line"></i> Go to Live Tracking
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Quick Stats -->
                <div class="row mt-4">

                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="p-3 text-center bg-success text-white rounded shadow-sm">
                            <i class="fas fa-plug fa-2x mb-2"></i>
                            <h5>{{ online_count }}</h5>
                            <small>Currently Online</small>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="p-3 text-center bg-info text-white rounded shadow-sm">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <h5>{{ last_24h_activity }}</h5>
                            <small>Active Last 24h</small>
                        </div>
                    </div>

                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="p-3 text-center bg-danger text-white rounded shadow-sm">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <h5>{{ offline_count }}</h5>
                            <small>Currently Offline</small>
                        </div>
                    </div>

                </div>


                <!-- Device List -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Device</th>
                                <th>Status</th>
                                <th>Network Info</th>
                                <th>Last Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deviceList">
                            {% for device in saved_devices %}
                            {% set device_status = check_device_status(device) %}
                            <tr id="device-row-{{ device.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="device-icon me-3">
                                            <i class="fas fa-laptop fa-2x text-muted"></i>
                                        </div>
                                        <div>
                                            <strong>{{ device.device_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ device.employee_name or 'Unassigned' }}</small>
                                            {% if device.department %}
                                            <br><span class="badge bg-info">{{ device.department }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if device_status == 'online' %}
                                    <span class="status-indicator status-online"></span> <span
                                        class="text-success fw-bold">Online</span>
                                    {% elif device_status == 'offline' %}
                                    <span class="status-indicator status-offline"></span> <span
                                        class="text-danger fw-bold">Offline</span>
                                    {% else %}
                                    <span class="status-indicator status-warning"></span> <span
                                        class="text-warning fw-bold">Unknown</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">
                                        {% if device.last_seen %}
                                        {{ device.last_seen.strftime('%Y-%m-%d') }}
                                        {% else %}
                                        Never
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div>
                                        <small><strong>IP:</strong>
                                            <code>{{ device.ip_address or 'N/A' }}</code></small>
                                        <br>
                                        <small><strong>MAC:</strong> {{ device.mac_address }}</small>
                                        <br>
                                        <small><strong>Host:</strong> {{ device.hostname or 'N/A' }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if device.last_seen %}
                                    {{ device.last_seen.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                    <span class="text-muted">Never</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">
                                        {% if device.created_at %}
                                        Added: {{ device.created_at.strftime('%Y-%m-%d') }}
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('tracking_bp.live_tracking') }}?device_id={{ device.id }}"
                                                class="btn btn-outline-primary" title="Live Tracking">
                                                <i class="fas fa-play"></i> Live
                                            </a>
                                            <a href="{{ url_for('tracking_bp.device_history', device_id=device.id) }}"
                                                class="btn btn-outline-info" title="View History">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        </div>
                                        <div class="btn-group btn-group-sm mt-1" role="group">
                                            <button class="btn btn-outline-warning edit-device"
                                                data-device='{{ device.to_dict() | tojson }}' title="Edit Device">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger delete-device"
                                                data-mac="{{ device.mac_address }}"
                                                data-device-name="{{ device.device_name }}" title="Delete Device">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <i class="fas fa-laptop fa-3x text-muted mb-3"></i>
                                    <h5>No Devices Configured</h5>
                                    <p class="text-muted">Scan your network or add devices manually to get started.</p>
                                    <button class="btn btn-primary mt-2" data-bs-toggle="modal"
                                        data-bs-target="#addDeviceModal">
                                        <i class="fas fa-plus"></i> Add Your First Device
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions -->
                {% if saved_devices %}
                <div class="mt-3 border-top pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">{{ saved_devices|length }} device(s) total</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" id="exportDevicesBtn">
                                <i class="fas fa-download"></i> Export List
                            </button>
                            <button class="btn btn-sm btn-outline-warning" id="bulkEditBtn">
                                <i class="fas fa-edit"></i> Bulk Edit
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deviceForm">
                    <input type="hidden" id="editMac" name="mac_address">

                    <div class="mb-3">
                        <label class="form-label">Device Name *</label>
                        <input type="text" class="form-control" id="deviceName" name="device_name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Employee Name</label>
                        <input type="text" class="form-control" id="employeeName" name="employee_name">
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">MAC Address *</label>
                                <input type="text" class="form-control" id="macAddress" name="mac_address" required
                                    pattern="([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})">
                                <div class="form-text">Format: 00:1A:2B:3C:4D:5E</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">IP Address</label>
                                <input type="text" class="form-control" id="ipAddress" name="ip_address"
                                    pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Hostname</label>
                                <input type="text" class="form-control" id="hostname" name="hostname">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" id="department" name="department">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDeviceBtn">Save Device</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete device <strong id="deleteDeviceName">[Device Name]</strong>?</p>
                <p class="text-danger"><small>This action cannot be undone. All tracking history for this device will be
                        lost.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Device</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
    // Global variables for device management
    let deviceToDelete = null;

    // Define showNotification helper if missing
    function showNotification(message, type = 'info') {
        const container = document.querySelector('.main-content') || document.body;
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        // Insert at the top of main content
        container.insertBefore(alertDiv, container.firstChild);

        // Auto dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function () {
        attachDeviceManagementListeners();
    });

    // Attach event listeners for device management
    function attachDeviceManagementListeners() {
        // Scan button
        // Scan button
        const scanBtn = document.getElementById('trackingScanBtn');
        if (scanBtn) {
            scanBtn.addEventListener('click', function () {
                console.log("Tracking Scan button clicked!");
                // alert("Starting Scan..."); // Uncomment if needed for extreme debugging
                const btn = this;
                const originalText = btn.innerHTML;

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
                btn.disabled = true;

                fetch('/api/tracking/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        console.log("Scan response received:", response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Scan data:", data);
                        if (data.success) {
                            displayScanResults(data.devices_found, data.total_found, data.tracking_active, data.port_only, data.new_devices);

                            if (data.updated_ips && data.updated_ips.length > 0) {
                                showNotification(`Updated IP addresses for ${data.updated_ips.length} device(s)`, 'success');
                            }
                        } else {
                            showNotification('Scan failed: ' + data.error, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Scan error:', error);
                        alert('Scan Error: ' + error.message);
                        showNotification('Scan error: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    });
            });
        }

        // Sync IPs manually
        document.getElementById('syncBtn').addEventListener('click', function () {
            const btn = this;
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            btn.disabled = true;

            fetch('/api/tracking/sync-ips', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (data.updated_devices && data.updated_devices.length > 0) {
                            showNotification(`Updated IP addresses for ${data.updated_devices.length} device(s)`, 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showNotification('All devices are up to date!', 'info');
                        }
                    } else {
                        showNotification('Sync failed: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Sync error:', error);
                    showNotification('Sync error: ' + error.message, 'danger');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        });

        // Save device
        document.getElementById('saveDeviceBtn').addEventListener('click', function () {
            const formData = {
                device_name: document.getElementById('deviceName').value,
                employee_name: document.getElementById('employeeName').value,
                mac_address: document.getElementById('macAddress').value,
                ip_address: document.getElementById('ipAddress').value,
                hostname: document.getElementById('hostname').value,
                department: document.getElementById('department').value,
                notes: document.getElementById('notes').value
            };

            if (!formData.device_name || !formData.mac_address) {
                showNotification('Device Name and MAC Address are required', 'warning');
                return;
            }

            // Validate MAC address format
            const macPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
            if (!macPattern.test(formData.mac_address)) {
                showNotification('Invalid MAC address format. Use format: 00:1A:2B:3C:4D:5E', 'warning');
                return;
            }

            fetch('/api/tracking/save-device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('Device saved successfully!', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addDeviceModal'));
                        modal.hide();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showNotification('Save failed: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Save error:', error);
                    showNotification('Save error: ' + error.message, 'danger');
                });
        });

        // Edit device buttons
        document.querySelectorAll('.edit-device').forEach(btn => {
            btn.addEventListener('click', function () {
                // Use inline data attributes instead of parsing JSON
                const device = {
                    device_name: this.closest('tr').querySelector('.device-name').textContent.trim(),
                    employee_name: this.closest('tr').querySelector('.employee-name').textContent.trim(),
                    mac_address: this.getAttribute('data-mac'),
                    ip_address: this.closest('tr').querySelector('.device-ip').textContent.trim(),
                    hostname: this.closest('tr').querySelector('.device-hostname')?.textContent.trim() || '',
                    department: this.closest('tr').querySelector('.device-department')?.textContent.trim() || '',
                    notes: this.getAttribute('data-notes') || ''
                };
                populateEditForm(device);
            });
        });

        // Delete device buttons
        document.querySelectorAll('.delete-device').forEach(btn => {
            btn.addEventListener('click', function () {
                const macAddress = this.getAttribute('data-mac');
                const deviceName = this.getAttribute('data-device-name');
                showDeleteConfirmation(macAddress, deviceName);
            });
        });

        // Confirm delete button
        document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
            if (deviceToDelete) {
                deleteDevice(deviceToDelete);
            }
        });

        // Export devices button
        document.getElementById('exportDevicesBtn')?.addEventListener('click', function () {
            exportDevicesList();
        });

        // Bulk edit button
        document.getElementById('bulkEditBtn')?.addEventListener('click', function () {
            showNotification('Bulk edit feature coming soon!', 'info');
        });

        // Clear form when modal is hidden
        document.getElementById('addDeviceModal').addEventListener('hidden.bs.modal', function () {
            clearDeviceForm();
        });
    }

    // Show delete confirmation modal
    function showDeleteConfirmation(macAddress, deviceName) {
        deviceToDelete = macAddress;
        document.getElementById('deleteDeviceName').textContent = deviceName;

        const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        deleteModal.show();
    }

    // Delete device
    function deleteDevice(macAddress) {
        fetch('/api/tracking/delete-device', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ mac_address: macAddress })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification('Device deleted successfully!', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
                    modal.hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Delete failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showNotification('Delete error: ' + error.message, 'danger');
            });
    }

    // Populate edit form
    function populateEditForm(device) {
        document.getElementById('modalTitle').textContent = 'Edit Device';
        document.getElementById('deviceName').value = device.device_name || '';
        document.getElementById('employeeName').value = device.employee_name || '';
        document.getElementById('macAddress').value = device.mac_address || '';
        document.getElementById('ipAddress').value = device.ip_address || '';
        document.getElementById('hostname').value = device.hostname || '';
        document.getElementById('department').value = device.department || '';
        document.getElementById('notes').value = device.notes || '';

        const modal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
        modal.show();
    }

    // Clear device form
    function clearDeviceForm() {
        document.getElementById('modalTitle').textContent = 'Add New Device';
        document.getElementById('deviceForm').reset();
    }

    // Export devices list
    function exportDevicesList() {
        // Fetch devices from API instead of using template variable
        fetch('/api/tracking/live-summary')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    createCSVExport(data.devices);
                } else {
                    showNotification('Failed to load devices for export', 'danger');
                }
            })
            .catch(error => {
                console.error('Export error:', error);
                showNotification('Export error: ' + error.message, 'danger');
            });
    }

    // Create CSV from devices data
    function createCSVExport(devices) {
        // Create CSV content
        let csvContent = "Device Name,Employee Name,Status,Last Seen\n";

        devices.forEach(device => {
            const lastSeen = device.timestamp ? new Date(device.timestamp).toLocaleDateString() : 'Never';
            csvContent += `"${device.device_name}","${device.employee_name || ''}","${device.status || 'offline'}","${lastSeen}"\n`;
        });

        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `devices-export-${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        showNotification('Device list exported successfully!', 'success');
    }

    // Display scan results
    function displayScanResults(devices, totalFound, trackingActive, portOnly, newDevices) {
        const scanResults = document.getElementById('scanResults');

        if (devices.length === 0) {
            scanResults.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5>No Devices Found</h5>
                <p class="text-muted">No devices with port 5002 open were found on your network.</p>
                <small class="text-muted">Make sure the tracking service is running on target devices.</small>
            </div>
        `;
            return;
        }

        let html = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Found ${totalFound} device(s) with port 5002 open
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-success text-white mb-3">
                    <div class="card-body text-center">
                        <h3>${trackingActive}</h3>
                        <p>Tracking Active</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white mb-3">
                    <div class="card-body text-center">
                        <h3>${portOnly}</h3>
                        <p>Port Open Only</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white mb-3">
                    <div class="card-body text-center">
                        <h3>${newDevices}</h3>
                        <p>New Devices</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Status</th>
                        <th>Network Info</th>
                        <th>Tracking</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
    `;

        devices.forEach(device => {
            let statusBadge, statusText;
            if (device.status === 'tracking_active') {
                statusBadge = 'bg-success';
                statusText = 'Tracking Active';
            } else if (device.status === 'port_open_no_service') {
                statusBadge = 'bg-warning';
                statusText = 'Port Open';
            } else {
                statusBadge = 'bg-secondary';
                statusText = 'Unknown';
            }

            const isSaved = device.is_saved || false;
            const saveButton = isSaved
                ? '<button class="btn btn-sm btn-outline-secondary" disabled>Already Saved</button>'
                : `<button class="btn btn-sm btn-outline-primary save-scanned-device" 
                      data-mac="${device.mac_address}"
                      data-ip="${device.ip}"
                      data-hostname="${device.hostname}"
                      data-system="${device.system}">
                 <i class="fas fa-save"></i> Save
               </button>`;

            html += `
            <tr>
                <td>
                    <strong>${device.hostname}</strong><br>
                    <small class="text-muted">${device.system}</small>
                </td>
                <td>
                    <span class="badge ${statusBadge}">${statusText}</span>
                </td>
                <td>
                    <small><strong>IP:</strong> ${device.ip}</small><br>
                    <small><strong>MAC:</strong> ${device.mac_address}</small>
                </td>
                <td>
                    ${device.tracking_data ? 'Active' : 'Inactive'}
                </td>
                <td>
                    ${saveButton}
                </td>
            </tr>
        `;
        });

        html += `
                </tbody>
            </table>
        </div>
    `;

        scanResults.innerHTML = html;

        // Attach event listeners to save buttons
        document.querySelectorAll('.save-scanned-device').forEach(btn => {
            btn.addEventListener('click', function () {
                const device = {
                    mac_address: this.getAttribute('data-mac'),
                    ip: this.getAttribute('data-ip'),
                    hostname: this.getAttribute('data-hostname'),
                    system: this.getAttribute('data-system')
                };
                saveScannedDevice(device);
            });
        });
    }

    // Save scanned device
    function saveScannedDevice(device) {
        const formData = {
            device_name: device.hostname || 'Unknown Device',
            employee_name: '',
            mac_address: device.mac_address,
            ip_address: device.ip,
            hostname: device.hostname,
            department: '',
            notes: 'Added from network scan'
        };

        fetch('/api/tracking/save-device', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Device saved successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification('Save failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showNotification('Save error: ' + error.message, 'danger');
            });
    }

    // Show notification
    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        animation: slideInRight 0.3s ease-out;
    `;

        notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        // Add to page
        document.body.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .device-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
`;
    document.head.appendChild(style);
</script>

<style>
    /* Additional styles for device management */
    #deviceList tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .device-icon {
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .badge {
        font-weight: 500;
    }

    .table th {
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}
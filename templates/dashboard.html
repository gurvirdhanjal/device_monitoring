{% extends "base.html" %}

{% block title %}Tactical Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Smooth tab transitions for Network Intelligence */
    .tab-content {
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 220ms ease, transform 220ms ease;
        will-change: opacity, transform;
    }

    .tab-content.is-active {
        opacity: 1;
        transform: translateY(0);
    }

    .tab-content.is-leaving {
        opacity: 0;
        transform: translateY(6px);
    }
</style>
{% endblock %}

{% block content %}

<div class="container-fluid tactical-theme">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 text-uppercase mb-0" style="letter-spacing: 2px; color: var(--tactical-text-primary);">Network
                Overview
            </h2>
            <div class="tactical-text-muted small mt-1">
                Last updated: <span id="last-updated-text">Just now</span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <!-- Live Clock -->
            <div id="live-clock" class="tactical-clock me-2">
                <span id="clock-date"></span>
                <span id="clock-time"></span>
            </div>

            <!-- Connection Status Indicator -->
            <div id="connection-indicator"></div>

            <!-- Time Range Selector -->
            <select id="time-range" class="tactical-select form-select-sm" style="width: auto;">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
            </select>

            <button id="btn-refresh" class="btn tactical-btn-outline btn-sm">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Error Banner -->
    <div id="global-error" class="alert alert-danger" style="display: none;"></div>

    <!-- ROW 1: Network Health Cards -->
    <div class="row g-4 mb-4">
        <!-- Devices Online -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="tactical-stat-card" id="card-devices-online">
                <div class="stat-label">Devices Online</div>
                <div class="stat-value" id="val-devices-online">-/-</div>
                <div class="metric-sub mt-2" id="sub-devices-online">
                    <span class="text-secondary">Loading...</span>
                </div>
                <i class="fas fa-server stat-icon"></i>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="tactical-stat-card" id="card-active-alerts">
                <div class="stat-label">Active Alerts</div>
                <div class="stat-value" id="val-active-alerts">-</div>
                <div class="metric-sub mt-2" id="sub-active-alerts">
                    <span class="text-secondary">Loading...</span>
                </div>
                <i class="fas fa-bell stat-icon"></i>
            </div>
        </div>

        <!-- Network Performance -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="tactical-stat-card" id="card-network-perf">
                <div class="stat-label">Performance</div>
                <div class="stat-value" id="val-latency">- ms</div>
                <div class="metric-sub mt-2" id="sub-packet-loss">
                    Loading...
                </div>
                <i class="fas fa-network-wired stat-icon"></i>
            </div>
        </div>

        <!-- Availability -->
        <div class="col-12 col-md-6 col-lg-3">
            <div class="tactical-stat-card" id="card-network-avail">
                <div class="stat-label">Availability (24h)</div>
                <div class="stat-value" id="val-availability">-%</div>
                <!-- Sparkline Container -->
                <div style="height: 40px; position: relative; margin-top: 10px;">
                    <canvas id="chart-availability-spark"></canvas>
                </div>
                <i class="fas fa-chart-line stat-icon"></i>
            </div>
        </div>
    </div>

    <!-- ROW 2: Tabs Section -->
    <div class="row g-4 mb-4">

        <!-- Main Tabbed Content -->
        <div class="col-lg-8">
            <div class="tactical-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-project-diagram"></i> Network Intelligence</span>
                    <div class="tabs">
                        <button class="tactical-tab active" data-target="tab-latency">Latency</button>
                        <button class="tactical-tab" data-target="tab-loss">Loss</button>
                        <button class="tactical-tab" data-target="tab-alerts">Alerts</button>
                        <button class="tactical-tab" data-target="tab-inventory-list">Inventory</button>
                        <button class="tactical-tab" data-target="tab-discovery">Discovery</button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <!-- Tab Content: Latency -->
                    <div id="tab-latency" class="tab-content" style="display: block;">
                        <table class="tactical-table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Latency</th>
                                    <th class="d-none d-md-table-cell">IP</th>
                                </tr>
                            </thead>
                            <tbody id="table-top-latency-body">
                                <tr>
                                    <td colspan="3" class="text-center text-secondary p-3">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tab Content: Packet Loss -->
                    <div id="tab-loss" class="tab-content" style="display: none;">
                        <table class="tactical-table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Loss %</th>
                                    <th class="d-none d-md-table-cell">IP</th>
                                </tr>
                            </thead>
                            <tbody id="table-top-loss-body">
                                <tr>
                                    <td colspan="3" class="text-center text-secondary p-3">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tab Content: Recent Alerts -->
                    <div id="tab-alerts" class="tab-content" style="display: none;">
                        <table class="tactical-table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Sev</th>
                                    <th>Message</th>
                                    <th class="d-none d-md-table-cell">Time</th>
                                </tr>
                            </thead>
                            <tbody id="table-recent-alerts-body">
                                <tr>
                                    <td colspan="3" class="text-center text-secondary p-3">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Tab Content: Device Inventory -->
                    <div id="tab-inventory-list" class="tab-content" style="display: none;">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="tactical-table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <div class="form-check d-flex justify-content-center">
                                                <input class="form-check-input" type="checkbox"
                                                    id="inventory-select-all">
                                            </div>
                                        </th>
                                        <th>Name</th>
                                        <th>Brand</th>
                                        <th>Tier</th>
                                        <th>IP</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="table-inventory-body">
                                    <tr>
                                        <td colspan="5" class="text-center p-3">Loading Inventory...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab Content: Network Discovery -->
                    <div id="tab-discovery" class="tab-content" style="display: none;">
                        <div class="p-4">
                            <h5 class="tactical-text-primary mb-3"><i class="fas fa-search-location"></i> Recursive
                                Switch Discovery</h5>
                            <p class="small tactical-text-muted">Enter a seed IP to start crawling switch neighbors via
                                LLDP/CDP.</p>
                            <div class="input-group mb-3" style="max-width: 450px;">
                                <input type="text" id="seed-ip" class="form-control tactical-input"
                                    placeholder="e.g. 192.168.1.1">
                                <button class="btn btn-primary" id="btn-start-discovery">Start Mapping</button>
                            </div>
                            <div id="discovery-status" class="small mt-2 p-2 rounded"
                                style="background: rgba(255,255,255,0.05); display: none;"></div>

                            <div id="discovery-results" class="mt-3" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-lg-6">
                                        <div class="tactical-card">
                                            <div class="card-header">
                                                <i class="fas fa-project-diagram"></i> Switches Found
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive"
                                                    style="max-height: 260px; overflow-y: auto;">
                                                    <table class="table tactical-table table-hover mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Switch IP</th>
                                                                <th>Neighbors</th>
                                                                <th>Devices</th>
                                                                <th>Errors</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="discovery-switches-body">
                                                            <tr>
                                                                <td colspan="4" class="text-center p-3">No results
                                                                    yet.</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-lg-6">
                                        <div class="tactical-card">
                                            <div class="card-header">
                                                <i class="fas fa-sitemap"></i> Devices Found
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive"
                                                    style="max-height: 260px; overflow-y: auto;">
                                                    <table class="table tactical-table table-hover mb-0">
                                                        <thead>
                                                            <tr>
                                                                <th>Switch IP</th>
                                                                <th>Device IP</th>
                                                                <th>MAC</th>
                                                                <th>Port</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="discovery-devices-body">
                                                            <tr>
                                                                <td colspan="4" class="text-center p-3">No results
                                                                    yet.</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Stats / Distribution -->
        <div class="col-lg-4">
            <div class="tactical-card h-100">
                <div class="card-header">
                    <i class="fas fa-boxes"></i> Inventory Breakdown
                </div>
                <div class="card-body">
                    <div style="height: 250px; position: relative;">
                        <canvas id="chart-inventory"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ROW 3: Real-Time Metrics -->
    <div class="row g-4 mb-4">
        <!-- Interface Utilization -->
        <div class="col-lg-6">
            <div class="tactical-card h-100">
                <div class="card-header">
                    <i class="fas fa-network-wired"></i> Top Interfaces Utilization
                </div>
                <div class="card-body">
                    <div style="height: 250px; position: relative;">
                        <canvas id="chart-interface-util"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network I/O Trend -->
        <div class="col-lg-6">
            <div class="tactical-card h-100">
                <div class="card-header">
                    <i class="fas fa-exchange-alt"></i> Network I/O Trend
                </div>
                <div class="card-body">
                    <div style="height: 250px; position: relative;">
                        <canvas id="chart-network-io"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script type="module" src="{{ url_for('static', filename='js/dashboard/dashboard.js') }}?v=2.8"></script>
{% endblock %}

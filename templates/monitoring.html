{% extends "base.html" %}

{% block title %}Real-time Monitoring - Device Monitoring{% endblock %}
{% block extra_css %}
<style>
    /* Monitoring - Tactical Theme (Minimal Overrides) */

    /* Statistics Cards */
    .stats-card {
        background: var(--tactical-bg-surface);
        border: 1px solid var(--tactical-border);
        border-radius: var(--tactical-radius-lg);
        padding: 1.5rem;
        text-align: center;
        transition: var(--tactical-transition);
    }

    .stats-card:hover {
        border-color: var(--tactical-border-accent);
        transform: translateY(-4px);
        box-shadow: var(--tactical-shadow-accent);
    }

    .stats-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        font-family: 'Orbitron', monospace;
    }

    .stats-card.primary h3 {
        color: var(--tactical-accent-bright);
    }

    .stats-card.success h3 {
        color: var(--tactical-success);
    }

    .stats-card.danger h3 {
        color: var(--tactical-danger);
    }

    .stats-card.info h3 {
        color: var(--tactical-accent);
    }

    .stats-card p {
        font-size: 0.875rem;
        color: var(--tactical-text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
    }

    /* Loading override */
    .loading {
        border: 4px solid var(--tactical-bg-elevated);
        border-top: 4px solid var(--tactical-accent);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-eye"></i> Real-time Device Monitoring</h1>
        <p class="lead">Live status of all monitored devices</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="fas fa-server"></i> Device Status</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <select class="form-select form-select-sm" id="statusFilter"
                                style="width: auto; display: inline-block;">
                                <option value="all">All Status</option>
                                <option value="Online">Online Only</option>
                                <option value="Offline">Offline Only</option>
                            </select>
                            <select class="form-select form-select-sm" id="typeFilter"
                                style="width: auto; display: inline-block;">
                                <option value="all">All Types</option>
                                <option value="camera">Camera</option>
                                <option value="router">Router</option>
                                <option value="switch">Switch</option>
                                <option value="server">Server</option>
                                <option value="workstation">Workstation</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" class="text-center">
                    <div class="loading"></div>
                    <p>Loading device status...</p>
                </div>
                <div id="devicesTable" style="display: none;">
                    <!-- Devices will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Monitoring Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row" id="statsContainer">
                    <!-- Statistics will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let refreshInterval;

    function loadDeviceStatus() {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;

        // Show loading
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('devicesTable').style.display = 'none';

        let url = '/api/monitoring/status';
        const params = new URLSearchParams();
        if (statusFilter !== 'all') params.append('status', statusFilter);
        if (typeFilter !== 'all') params.append('device_type', typeFilter);

        if (params.toString()) {
            url += '?' + params.toString();
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                displayDevices(data.devices);
                updateStatistics(data.devices);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('devicesTable').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading device status: ${error.message}
                </div>
            `;
                document.getElementById('devicesTable').style.display = 'block';
            })
            .finally(() => {
                document.getElementById('loadingIndicator').style.display = 'none';
            });
    }

    function displayDevices(devices) {
        if (devices.length === 0) {
            document.getElementById('devicesTable').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i> No devices found matching the current filters.
            </div>
        `;
            document.getElementById('devicesTable').style.display = 'block';
            return;
        }

        let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Device Name</th>
                        <th>IP Address</th>
                        <th>Type</th>
                        <th>Hostname</th>
                        <th>Status</th>
                        <th>Latency</th>
                        <th>Last Check</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

        devices.forEach(device => {
            const statusClass = device.status === 'Online' ? 'success' : 'danger';
            const statusIcon = device.status === 'Online' ? 'fa-wifi' : 'fa-times-circle';
            const latencyText = device.latency ? `${device.latency} ms` : 'N/A';
            const lastCheck = new Date().toLocaleTimeString();

            html += `
            <tr>
                <td>
                    <strong>${device.device_name}</strong>
                    ${device.is_monitored ? '<i class="fas fa-chart-line text-success ms-1" title="Monitored"></i>' : ''}
                </td>
                <td><code>${device.device_ip}</code></td>
                <td><span class="badge bg-secondary">${device.device_type}</span></td>
                <td>${device.hostname}</td>
                <td class="text-center" title="${device.status}">
                    <span class="status-indicator ${device.status === 'Online' ? 'status-online' : 'status-offline'}"></span>
                </td>

                <td>${latencyText}</td>
                <td><small class="text-muted">${lastCheck}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="viewDeviceDetails(${device.device_id})" title="View Details">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="toggleMonitoring(${device.device_id})" title="${device.is_monitored ? 'Stop Monitoring' : 'Start Monitoring'}">
                            <i class="fas ${device.is_monitored ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        });

        html += '</tbody></table></div>';
        document.getElementById('devicesTable').innerHTML = html;
        document.getElementById('devicesTable').style.display = 'block';
    }

    function updateStatistics(devices) {
        const totalDevices = devices.length;
        const onlineDevices = devices.filter(d => d.status === 'Online').length;
        const offlineDevices = devices.filter(d => d.status === 'Offline').length;
        const monitoredDevices = devices.filter(d => d.is_monitored).length;

        const onlinePercentage = totalDevices > 0 ? (onlineDevices / totalDevices * 100).toFixed(1) : 0;

        document.getElementById('statsContainer').innerHTML = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>${totalDevices}</h3>
                    <p>Total Devices</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>${onlineDevices}</h3>
                    <p>Online</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h3>${offlineDevices}</h3>
                    <p>Offline</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>${onlinePercentage}%</h3>
                    <p>Uptime</p>
                </div>
            </div>
        </div>
    `;
    }

    function viewDeviceDetails(deviceId) {
        // Navigate to device details page or show modal
        window.location.href = `/devices?edit_id=${deviceId}`;
    }

    function toggleMonitoring(deviceId) {
        fetch(`/api/devices/${deviceId}/toggle_monitoring`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDeviceStatus(); // Refresh the list
                } else {
                    alert('Error toggling monitoring');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error toggling monitoring');
            });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        // Load initial data
        loadDeviceStatus();

        // Set up auto-refresh every 30 seconds
        refreshInterval = setInterval(loadDeviceStatus, 30000);

        // Set up event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadDeviceStatus);
        document.getElementById('statusFilter').addEventListener('change', loadDeviceStatus);
        document.getElementById('typeFilter').addEventListener('change', loadDeviceStatus);
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', function () {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}File Transfer System{% endblock %}

{% block extra_css %}
<!-- Tactical theme applied - using base tactical.css -->
{% endblock %}

{% block content %}
<div class="file-transfer-container">
    <!-- Header -->
    <div class="transfer-header">
        <h1><i class="fas fa-exchange-alt"></i> LAN File Transfer System</h1>
        <p class="mb-0">Transfer files between admin system and client devices over LAN</p>
    </div>

    <!-- Client Discovery & Connection -->
    <div class="client-discovery">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-search-network"></i> Discover Clients</h4>
            <div>
                <button class="btn btn-sm btn-primary" onclick="discoverClients()">
                    <i class="fas fa-sync-alt"></i> Scan Network
                </button>
                <button class="btn btn-sm btn-success" onclick="connectManual()">
                    <i class="fas fa-plug"></i> Manual Connect
                </button>
            </div>
        </div>
        
        <div class="connection-status">
            <span class="status-indicator" id="connectionStatus"></span>
            <span id="connectionText">Not connected to any client</span>
        </div>

        <div id="clientsList" class="clients-grid">
            <!-- Client cards will appear here -->
            <div class="empty-state">
                <i class="fas fa-laptop-house"></i>
                <h4>No clients discovered</h4>
                <p>Click "Scan Network" to discover clients</p>
            </div>
        </div>

        <div id="manualConnectForm" style="display: none; margin-top: 20px;">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label text-light">Client IP Address</label>
                    <input type="text" class="form-control" id="manualIP" placeholder="192.168.1.100">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-light">Port</label>
                    <input type="number" class="form-control" id="manualPort" value="5002">
                </div>
                <div class="col-md-5 d-flex align-items-end">
                    <button class="btn btn-primary me-2" onclick="connectToManual()">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button class="btn btn-secondary" onclick="hideManualForm()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dual Panel Layout -->
    <div class="dual-panel-layout">
        <!-- Server (Admin) Panel -->
        <div class="explorer-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">
                        <i class="fas fa-server"></i> Server Files
                    </div>
                    <div class="path-display" id="serverPath">Loading...</div>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-sm btn-outline-light" onclick="createFolder('server')">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshServer()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="breadcrumb" id="serverBreadcrumb">
                <span class="breadcrumb-item" onclick="navigateServer('')">
                    <i class="fas fa-home"></i> Root
                </span>
            </div>
            
            <div class="file-explorer" id="serverExplorer">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h4>Loading server files...</h4>
                </div>
            </div>
        </div>

        <!-- Transfer Controls -->
        <div class="transfer-controls">
            <button class="transfer-button btn-copy-to-client" onclick="transferFiles('client', 'copy')" disabled>
                <i class="fas fa-arrow-right"></i> Copy to Client
            </button>
            
            <button class="transfer-button btn-move-to-client" onclick="transferFiles('client', 'move')" disabled>
                <i class="fas fa-arrow-right"></i> Move to Client
            </button>
            
            <div style="margin: 20px 0; text-align: center;">
                <i class="fas fa-exchange-alt fa-2x text-muted"></i>
            </div>
            
            <button class="transfer-button btn-copy-to-server" onclick="transferFiles('server', 'copy')" disabled>
                <i class="fas fa-arrow-left"></i> Copy to Server
            </button>
            
            <button class="transfer-button btn-move-to-server" onclick="transferFiles('server', 'move')" disabled>
                <i class="fas fa-arrow-left"></i> Move to Server
            </button>
            
            <div class="mt-4 text-center">
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Select files from either panel to enable transfers
                </p>
            </div>
        </div>

        <!-- Client Panel -->
        <div class="explorer-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">
                        <i class="fas fa-laptop"></i> Client Files
                        <span id="clientName" class="ms-2 text-warning"></span>
                    </div>
                    <div class="path-display" id="clientPath">Not connected</div>
                </div>
                <div class="panel-actions">
                    <button class="btn btn-sm btn-outline-light" onclick="createFolder('client')" disabled id="clientFolderBtn">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshClient()" disabled id="clientRefreshBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="breadcrumb" id="clientBreadcrumb">
                <span class="breadcrumb-item" onclick="navigateClient('')">
                    <i class="fas fa-home"></i> Root
                </span>
            </div>
            
            <div class="file-explorer" id="clientExplorer">
                <div class="empty-state">
                    <i class="fas fa-laptop"></i>
                    <h4>Connect to a client first</h4>
                    <p>Discover and connect to view client files</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Selected Items Panel -->
    <div class="selected-items-panel" id="selectedItemsPanel" style="display: none;">
        <h6><i class="fas fa-check-circle"></i> Selected Items</h6>
        <div id="selectedItemsList"></div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="action-btn" onclick="downloadSelected('server')" disabled id="downloadServerBtn">
            <i class="fas fa-download"></i> Download from Server
        </button>
        <button class="action-btn" onclick="downloadSelected('client')" disabled id="downloadClientBtn">
            <i class="fas fa-download"></i> Download from Client
        </button>
        <button class="action-btn" onclick="deleteSelected('server')" disabled id="deleteServerBtn">
            <i class="fas fa-trash"></i> Delete from Server
        </button>
        <button class="action-btn" onclick="deleteSelected('client')" disabled id="deleteClientBtn">
            <i class="fas fa-trash"></i> Delete from Client
        </button>
        <button class="action-btn" onclick="showSystemInfo('client')" disabled id="infoClientBtn">
            <i class="fas fa-info-circle"></i> Client System Info
        </button>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h4><i class="fas fa-cloud-upload-alt"></i> Upload Files</h4>
        <div class="mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="uploadTarget" 
                       id="uploadToServer" value="server" checked>
                <label class="form-check-label text-light" for="uploadToServer">
                    <i class="fas fa-server"></i> Upload to Server
                </label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="uploadTarget" 
                       id="uploadToClient" value="client">
                <label class="form-check-label text-light" for="uploadToClient">
                    <i class="fas fa-laptop"></i> Upload to Client
                </label>
            </div>
        </div>
        
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="mb-3">
                <h5 class="text-light">Drag & drop files here</h5>
                <p class="text-muted">or click to browse files</p>
            </div>
            <button class="btn btn-primary btn-lg">
                <i class="fas fa-folder-open"></i> Browse Files
            </button>
            <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect()">
        </div>
        
        <div id="uploadProgress" style="display: none; margin-top: 20px;">
            <div class="progress" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     id="uploadProgressBar" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-center">
                <span id="uploadStatus" class="text-light">Uploading...</span>
            </div>
        </div>
    </div>

    <!-- Client Storage Info -->
    <div class="storage-info" id="clientStorageInfo" style="display: none;">
        <h5><i class="fas fa-database"></i> Client Storage Information</h5>
        <div id="storageDetails"></div>
    </div>
</div>

<!-- Transfer Confirmation Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt"></i> Confirm File Transfer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transferDetails"></div>
                <div class="mb-3">
                    <label class="form-label text-dark">Transfer Action:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="transferAction" 
                               id="transferCopy" value="copy" checked>
                        <label class="form-check-label text-dark" for="transferCopy">
                            <i class="fas fa-copy"></i> Copy (Keep original files)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="transferAction" 
                               id="transferMove" value="move">
                        <label class="form-check-label text-dark" for="transferMove">
                            <i class="fas fa-arrows-alt-h"></i> Move (Remove original files)
                        </label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-dark">Destination Path:</label>
                    <input type="text" class="form-control" id="destinationPath" 
                           placeholder="Leave empty for current directory">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmTransfer()">
                    <i class="fas fa-check"></i> Start Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Info Modal -->
<div class="modal fade" id="systemInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle"></i> Client System Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="systemInfoContent">
                Loading system information...
            </div>
        </div>
    </div>
</div>
<!-- Development Warning Modal -->
<div class="modal fade" id="devWarningModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-radiation"></i> DANGER: DO NOT USE
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-bug fa-4x text-danger mb-3"></i>
                    <h1 class="text-danger fw-bold">⚠️ WARNING: DEVELOPMENT VERSION</h1>
                </div>
                
                <div class="alert alert-danger">
                    <h4><i class="fas fa-skull-crossbones"></i> CRITICAL WARNING:</h4>
                    <p class="fs-5 mb-2"><strong>DO NOT USE THIS FEATURE!</strong></p>
                    <p class="mb-0">This file transfer system is <strong class="text-decoration-underline">STILL IN DEVELOPMENT</strong> and <strong class="text-decoration-underline">CAN HARM YOUR PROJECT</strong>.</p>
                </div>
                
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle"></i> Why you should go back:</h5>
                    <ul class="text-start mb-0">
                        <li><strong>Data Corruption Risk:</strong> May corrupt or delete important files</li>
                        <li><strong>Security Vulnerabilities:</strong> No security measures implemented yet</li>
                        <li><strong>System Instability:</strong> Can crash or freeze your system</li>
                        <li><strong>Unfinished Features:</strong> Most functions don't work properly</li>
                        <li><strong>Testing Mode Only:</strong> Not meant for actual file transfers</li>
                    </ul>
                </div>
                
                <div class="alert alert-dark">
                    <h6><i class="fas fa-hand-point-right"></i> <strong>This is NOT a production-ready feature</strong></h6>
                    <p class="mb-0">This is purely for testing and development purposes. Using it for real file transfers WILL cause problems.</p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-success" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> <strong>GO BACK TO SAFETY</strong>
                </button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    <i class="fas fa-biohazard"></i> <strong>I UNDERSTAND THE RISKS - PROCEED ANYWAY</strong>
                </button>
            </div>
            
            <div class="modal-footer justify-content-center">
                <small class="text-muted">
                    <i class="fas fa-shield-alt"></i> 
                    <strong>ADMIN NOTE:</strong> This feature is still in testing mode. Do not use for production data.
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global state
    let currentClient = null;
    let selectedFiles = {
        server: [],
        client: []
    };
    let currentPaths = {
        server: '',
        client: ''
    };
    let transferConfig = {
        direction: '',
        action: 'copy'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadServerFiles();
        checkCurrentConnection();
    });

    // Discover clients in network
    async function discoverClients() {
        showLoading('Discovering clients in network...');
        
        try {
            const response = await fetch('/api/clients/discover');
            const data = await response.json();
            
            if (data.success && data.clients.length > 0) {
                renderClientsList(data.clients);
            } else {
                showError('No clients found in network');
                document.getElementById('clientsList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h4>No clients found</h4>
                        <p>No clients responded to discovery request</p>
                    </div>
                `;
            }
        } catch (error) {
            showError('Failed to discover clients');
        }
        
        hideLoading();
    }

    // Render clients list
    function renderClientsList(clients) {
        const container = document.getElementById('clientsList');
        let html = '';
        
        clients.forEach(client => {
            html += `
                <div class="client-card" onclick="connectToClient('${client.ip}', ${client.port})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="client-ip">${client.ip}:${client.port}</div>
                            <div class="text-muted">${client.hostname}</div>
                        </div>
                        <div class="client-status">
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Online</span>
                        </div>
                    </div>
                    <div class="mt-2 text-muted">
                        <small><i class="far fa-clock"></i> Last seen: ${new Date(client.last_seen).toLocaleTimeString()}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Connect to client
    async function connectToClient(ip, port = 5002) {
        showLoading(`Connecting to ${ip}:${port}...`);
        
        try {
            const response = await fetch('/api/clients/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ip, port })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentClient = data.client;
                updateConnectionStatus(true, `${ip}:${port}`);
                showSuccess(`Connected to ${ip}`);
                
                // Enable client controls
                document.getElementById('clientFolderBtn').disabled = false;
                document.getElementById('clientRefreshBtn').disabled = false;
                document.getElementById('uploadToClient').disabled = false;
                
                // Load client files
                loadClientFiles();
            } else {
                showError(data.error || 'Connection failed');
            }
        } catch (error) {
            showError('Connection failed');
        }
        
        hideLoading();
    }

    // Manual connection
    function connectManual() {
        document.getElementById('manualConnectForm').style.display = 'block';
    }

    function hideManualForm() {
        document.getElementById('manualConnectForm').style.display = 'none';
    }

    async function connectToManual() {
        const ip = document.getElementById('manualIP').value.trim();
        const port = document.getElementById('manualPort').value;
        
        if (!ip) {
            showError('IP address is required');
            return;
        }
        
        await connectToClient(ip, port);
        hideManualForm();
    }

    // Disconnect from client
    async function disconnectClient() {
        try {
            await fetch('/api/clients/disconnect', {
                method: 'POST'
            });
            
            currentClient = null;
            updateConnectionStatus(false, 'Not connected');
            showSuccess('Disconnected from client');
            
            // Disable client controls
            document.getElementById('clientFolderBtn').disabled = true;
            document.getElementById('clientRefreshBtn').disabled = true;
            document.getElementById('uploadToClient').disabled = true;
            
            // Clear client explorer
            document.getElementById('clientExplorer').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-laptop"></i>
                    <h4>Not connected</h4>
                    <p>Connect to a client to view files</p>
                </div>
            `;
        } catch (error) {
            showError('Failed to disconnect');
        }
    }

    // Check current connection
    async function checkCurrentConnection() {
        try {
            const response = await fetch('/api/clients/current');
            const data = await response.json();
            
            if (data.success && data.client) {
                currentClient = data.client.info;
                updateConnectionStatus(true, `${data.client.ip}:${data.client.port}`);
                
                // Enable client controls
                document.getElementById('clientFolderBtn').disabled = false;
                document.getElementById('clientRefreshBtn').disabled = false;
                document.getElementById('uploadToClient').disabled = false;
                
                loadClientFiles();
            }
        } catch (error) {
            // No current connection
        }
    }

    // Update connection status UI
    function updateConnectionStatus(connected, text) {
        const statusIndicator = document.getElementById('connectionStatus');
        const statusText = document.getElementById('connectionText');
        const clientName = document.getElementById('clientName');
        
        if (connected) {
            statusIndicator.className = 'status-indicator status-online';
            statusText.textContent = `Connected to: ${text}`;
            clientName.textContent = `(${text})`;
        } else {
            statusIndicator.className = 'status-indicator status-offline';
            statusText.textContent = text;
            clientName.textContent = '';
        }
    }

    // Load server files
    async function loadServerFiles(path = '') {
        try {
            const response = await fetch('/api/files/local/list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentPaths.server = data.current_path;
                document.getElementById('serverPath').textContent = data.current_path;
                renderFileExplorer('server', data.items);
                updateBreadcrumb('server', data.current_path);
            } else {
                showError('Failed to load server files');
            }
        } catch (error) {
            showError('Failed to load server files');
        }
    }

    // Load client files
    async function loadClientFiles(path = '') {
        if (!currentClient) return;
        
        try {
            const response = await fetch('/api/files/client/list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ path })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentPaths.client = data.current_path;
                document.getElementById('clientPath').textContent = data.current_path;
                renderFileExplorer('client', data.items);
                updateBreadcrumb('client', data.current_path);
            } else {
                showError('Failed to load client files');
            }
        } catch (error) {
            showError('Failed to load client files');
        }
    }

    // Render file explorer
    function renderFileExplorer(panel, items) {
        const container = document.getElementById(`${panel}Explorer`);
        
        if (!items || items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h4>Empty directory</h4>
                    <p>No files or folders found</p>
                </div>
            `;
            return;
        }
        
        let html = '<ul class="file-list">';
        
        items.forEach(item => {
            const isSelected = selectedFiles[panel].includes(item.path);
            const iconClass = item.is_dir ? 'folder' : 'file';
            const size = formatFileSize(item.size);
            const modified = new Date(item.modified * 1000).toLocaleString();
            
            html += `
                <li class="file-item ${isSelected ? 'selected' : ''}"
                    data-path="${item.path}"
                    data-name="${item.name}"
                    data-type="${item.is_dir ? 'folder' : 'file'}"
                    onclick="selectFile(event, '${panel}', '${item.path}')">
                    
                    <div class="file-icon ${iconClass}">
                        <i class="fas fa-${item.is_dir ? 'folder' : 'file'}"></i>
                    </div>
                    
                    <div class="file-info">
                        <div class="file-name">${item.name}</div>
                        <div class="file-details">
                            <span class="file-size">${size}</span>
                            <span>${modified}</span>
                            ${item.is_dir ? '<span class="badge bg-warning">Folder</span>' : ''}
                        </div>
                    </div>
                </li>
            `;
        });
        
        html += '</ul>';
        container.innerHTML = html;
    }

    // Select file
    function selectFile(event, panel, filePath) {
        event.stopPropagation();
        
        if (event.ctrlKey || event.metaKey) {
            // Multi-select
            const index = selectedFiles[panel].indexOf(filePath);
            if (index === -1) {
                selectedFiles[panel].push(filePath);
            } else {
                selectedFiles[panel].splice(index, 1);
            }
        } else {
            // Single select
            selectedFiles[panel] = [filePath];
            selectedFiles[panel === 'server' ? 'client' : 'server'] = [];
        }
        
        updateSelectionUI();
    }

    // Update selection UI
    function updateSelectionUI() {
        // Update file items
        ['server', 'client'].forEach(panel => {
            document.querySelectorAll(`#${panel}Explorer .file-item`).forEach(item => {
                const path = item.dataset.path;
                if (selectedFiles[panel].includes(path)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        });
        
        // Update transfer buttons
        const serverSelected = selectedFiles.server.length > 0;
        const clientSelected = selectedFiles.client.length > 0;
        
        document.querySelectorAll('.transfer-button').forEach(btn => {
            btn.disabled = !(serverSelected || clientSelected);
        });
        
        // Update action buttons
        document.getElementById('downloadServerBtn').disabled = selectedFiles.server.length === 0;
        document.getElementById('deleteServerBtn').disabled = selectedFiles.server.length === 0;
        document.getElementById('downloadClientBtn').disabled = selectedFiles.client.length === 0;
        document.getElementById('deleteClientBtn').disabled = selectedFiles.client.length === 0;
        document.getElementById('infoClientBtn').disabled = !currentClient;
        
        // Show/hide selected items panel
        const selectedPanel = document.getElementById('selectedItemsPanel');
        const selectedList = document.getElementById('selectedItemsList');
        
        const totalSelected = selectedFiles.server.length + selectedFiles.client.length;
        if (totalSelected > 0) {
            selectedPanel.style.display = 'block';
            
            let html = '';
            selectedFiles.server.forEach(path => {
                html += `<div class="selected-item">
                    <span><i class="fas fa-server"></i> ${path.split('/').pop() || path.split('\\\\').pop()}</span>
                    <span class="badge bg-primary">Server</span>
                </div>`;
            });
            
            selectedFiles.client.forEach(path => {
                html += `<div class="selected-item">
                    <span><i class="fas fa-laptop"></i> ${path.split('/').pop() || path.split('\\\\').pop()}</span>
                    <span class="badge bg-success">Client</span>
                </div>`;
            });
            
            selectedList.innerHTML = html;
        } else {
            selectedPanel.style.display = 'none';
        }
    }

    // Transfer files
    function transferFiles(direction, action) {
        const sourcePanel = direction === 'client' ? 'server' : 'client';
        const sourcePaths = selectedFiles[sourcePanel];
        
        if (sourcePaths.length === 0) {
            showError('No files selected');
            return;
        }
        
        transferConfig.direction = direction;
        transferConfig.action = action;
        
        const modal = new bootstrap.Modal(document.getElementById('transferModal'));
        const detailsDiv = document.getElementById('transferDetails');
        
        let html = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                ${action === 'copy' ? 'Copying' : 'Moving'} ${sourcePaths.length} item(s)
                ${direction === 'client' ? 'to client' : 'to server'}
            </div>
            <div class="selected-items-panel">
        `;
        
        sourcePaths.forEach(path => {
            const name = path.split('/').pop() || path.split('\\\\').pop();
            html += `<div class="selected-item">
                <span><i class="fas fa-file"></i> ${name}</span>
                <span class="badge bg-secondary">${path.includes('/') || path.includes('\\\\') ? 'File' : 'Folder'}</span>
            </div>`;
        });
        
        html += '</div>';
        detailsDiv.innerHTML = html;
        
        modal.show();
    }

    // Confirm transfer
    async function confirmTransfer() {
        const action = document.querySelector('input[name="transferAction"]:checked').value;
        const destinationPath = document.getElementById('destinationPath').value;
        const sourcePanel = transferConfig.direction === 'client' ? 'server' : 'client';
        const sourcePaths = selectedFiles[sourcePanel];
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
        modal.hide();
        
        showLoading(`Transferring ${sourcePaths.length} file(s)...`);
        
        try {
            const response = await fetch('/api/files/transfer_between', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source_paths: sourcePaths,
                    destination_type: transferConfig.direction,
                    destination_path: destinationPath || currentPaths[transferConfig.direction === 'client' ? 'client' : 'server'],
                    action: action
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(`Transferred ${data.transferred} item(s) successfully`);
                
                // Refresh both panels
                loadServerFiles(currentPaths.server);
                if (currentClient) {
                    loadClientFiles(currentPaths.client);
                }
                
                // Clear selection
                selectedFiles = { server: [], client: [] };
                updateSelectionUI();
            } else {
                showError('Transfer failed');
            }
        } catch (error) {
            showError('Transfer failed');
        }
        
        hideLoading();
    }

    // Download selected files
    async function downloadSelected(panel) {
        const paths = selectedFiles[panel];
        
        if (paths.length === 0) return;
        
        if (panel === 'server') {
            // Download from server
            if (paths.length === 1) {
                // Single file download
                try {
                    const response = await fetch('/api/files/local/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ path: paths[0] })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = paths[0].split('/').pop() || paths[0].split('\\\\').pop();
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }
                } catch (error) {
                    showError('Download failed');
                }
            }
        } else {
            // Download from client
            try {
                const response = await fetch('/api/files/client/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ path: paths[0] })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = paths[0].split('/').pop() || paths[0].split('\\\\').pop();
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (error) {
                showError('Download failed');
            }
        }
    }

    // Delete selected files
    async function deleteSelected(panel) {
        const paths = selectedFiles[panel];
        
        if (paths.length === 0) return;
        
        if (!confirm(`Are you sure you want to delete ${paths.length} item(s)? This action cannot be undone.`)) {
            return;
        }
        
        showLoading(`Deleting ${paths.length} item(s)...`);
        
        try {
            const endpoint = panel === 'server' ? '/api/files/local/delete' : '/api/files/client/delete';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ paths })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(`Deleted ${paths.length} item(s) successfully`);
                
                // Refresh panel
                if (panel === 'server') {
                    loadServerFiles(currentPaths.server);
                } else {
                    loadClientFiles(currentPaths.client);
                }
                
                // Clear selection
                selectedFiles[panel] = [];
                updateSelectionUI();
            } else {
                showError('Delete failed');
            }
        } catch (error) {
            showError('Delete failed');
        }
        
        hideLoading();
    }

    // Create folder
    async function createFolder(panel) {
        const path = currentPaths[panel];
        const name = prompt('Enter folder name:');
        
        if (!name || !name.trim()) {
            return;
        }
        
        try {
            const endpoint = panel === 'server' ? '/api/files/local/create_folder' : '/api/files/client/create_folder';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    path: path,
                    name: name.trim() 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(`Folder "${name}" created`);
                
                // Refresh panel
                if (panel === 'server') {
                    loadServerFiles(currentPaths.server);
                } else {
                    loadClientFiles(currentPaths.client);
                }
            } else {
                showError('Failed to create folder');
            }
        } catch (error) {
            showError('Failed to create folder');
        }
    }

    // Navigate
    function navigateServer(path) {
        loadServerFiles(path);
        selectedFiles.server = [];
        updateSelectionUI();
    }

    function navigateClient(path) {
        if (!currentClient) return;
        loadClientFiles(path);
        selectedFiles.client = [];
        updateSelectionUI();
    }

    // Update breadcrumb
    function updateBreadcrumb(panel, currentPath) {
        const container = document.getElementById(`${panel}Breadcrumb`);
        
        if (!currentPath) {
            container.innerHTML = `
                <span class="breadcrumb-item" onclick="navigate${panel === 'server' ? 'Server' : 'Client'}('')">
                    <i class="fas fa-home"></i> Root
                </span>
            `;
            return;
        }
        
        let html = `<span class="breadcrumb-item" onclick="navigate${panel === 'server' ? 'Server' : 'Client'}('')">
            <i class="fas fa-home"></i> Root
        </span>`;
        
        const parts = currentPath.split(/[\/\\\\]/).filter(p => p);
        let current = '';
        
        for (let i = 0; i < parts.length; i++) {
            current += (current ? '/' : '') + parts[i];
            html += `<span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item" onclick="navigate${panel === 'server' ? 'Server' : 'Client'}('${current}')">
                        ${parts[i]}
                    </span>`;
        }
        
        container.innerHTML = html;
    }

    // File upload handling
    function handleFileSelect() {
        const files = document.getElementById('fileInput').files;
        const target = document.querySelector('input[name="uploadTarget"]:checked').value;
        
        if (files.length === 0) return;
        
        if (target === 'client' && !currentClient) {
            showError('Please connect to a client first');
            return;
        }
        
        uploadFiles(files, target);
    }

    async function uploadFiles(files, target) {
        const formData = new FormData();
        const currentPath = target === 'server' ? currentPaths.server : currentPaths.client;
        
        formData.append('path', currentPath);
        
        for (let i = 0; i < files.length; i++) {
            formData.append('file', files[i]);
        }
        
        // Show progress
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('uploadProgressBar');
        const statusText = document.getElementById('uploadStatus');
        
        progressDiv.style.display = 'block';
        progressBar.style.width = '0%';
        statusText.textContent = `Uploading ${files.length} file(s)...`;
        
        try {
            const endpoint = target === 'server' ? '/api/files/local/upload' : '/api/files/client/upload';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                progressBar.style.width = '100%';
                statusText.textContent = `Uploaded ${data.uploaded} file(s) successfully`;
                
                // Refresh panel
                if (target === 'server') {
                    loadServerFiles(currentPaths.server);
                } else {
                    loadClientFiles(currentPaths.client);
                }
                
                // Clear file input
                document.getElementById('fileInput').value = '';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            } else {
                showError('Upload failed');
                progressDiv.style.display = 'none';
            }
        } catch (error) {
            showError('Upload failed');
            progressDiv.style.display = 'none';
        }
    }

    // Show system info
    async function showSystemInfo(panel) {
        if (panel === 'client' && !currentClient) return;
        
        try {
            const response = await fetch('/api/files/client/system_info');
            const data = await response.json();
            
            if (data.success) {
                const modal = new bootstrap.Modal(document.getElementById('systemInfoModal'));
                const contentDiv = document.getElementById('systemInfoContent');
                
                let html = `
                    <div class="mb-3">
                        <h6><i class="fas fa-computer"></i> System Information</h6>
                        <div class="card">
                            <div class="card-body">
                                <p><strong>Hostname:</strong> ${data.system.hostname}</p>
                                <p><strong>Platform:</strong> ${data.system.platform}</p>
                                <p><strong>Username:</strong> ${data.system.username}</p>
                                <p><strong>Home Directory:</strong> ${data.system.home_directory}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-database"></i> Storage Information</h6>
                `;
                
                data.storage.forEach(disk => {
                    const usedGB = (disk.used / (1024**3)).toFixed(2);
                    const totalGB = (disk.total / (1024**3)).toFixed(2);
                    const freeGB = (disk.free / (1024**3)).toFixed(2);
                    
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6>${disk.drive}</h6>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${disk.percent}%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <small>${usedGB} GB used</small>
                                    <small>${freeGB} GB free</small>
                                    <small>${totalGB} GB total</small>
                                </div>
                                <div class="text-center mt-1">
                                    <small class="text-muted">${disk.percent.toFixed(1)}% used</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-folder"></i> Special Directories</h6>
                        <div class="card">
                            <div class="card-body">
                `;
                
                for (const [key, value] of Object.entries(data.directories)) {
                    html += `<p><strong>${key}:</strong> ${value}</p>`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = html;
                modal.show();
            }
        } catch (error) {
            showError('Failed to get system information');
        }
    }

    // Refresh functions
    function refreshServer() {
        loadServerFiles(currentPaths.server);
        selectedFiles.server = [];
        updateSelectionUI();
    }

    function refreshClient() {
        if (!currentClient) return;
        loadClientFiles(currentPaths.client);
        selectedFiles.client = [];
        updateSelectionUI();
    }

    // Utility functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showLoading(message = 'Loading...') {
        // You can implement a loading overlay
        console.log(message);
    }

    function hideLoading() {
        // Hide loading overlay
    }

    function showSuccess(message) {
        alertify.success(message);
    }

    function showError(message) {
        alertify.error(message);
    }

    // Drag and drop
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const target = document.querySelector('input[name="uploadTarget"]:checked').value;
                uploadFiles(files, target);
            }
        });
    });

// Add this in your extra_js block, at the beginning of the script section
document.addEventListener('DOMContentLoaded', function() {
    // Show development warning modal
    const devModal = new bootstrap.Modal(document.getElementById('devWarningModal'));
    devModal.show();
    
    // Disable all interactive elements until user acknowledges warning
    disableAllControls(true);
    
    // When modal is closed, enable controls
    document.getElementById('devWarningModal').addEventListener('hidden.bs.modal', function() {
        disableAllControls(false);
    });
    
    // Load server files after modal interaction
    loadServerFiles();
    checkCurrentConnection();
});

// Function to disable/enable all controls
function disableAllControls(disable) {
    const interactiveElements = [
        '.transfer-button',
        '.action-btn',
        '#uploadArea',
        '#fileInput',
        '.btn-copy-to-client',
        '.btn-move-to-client',
        '.btn-copy-to-server',
        '.btn-move-to-server',
        '#downloadServerBtn',
        '#downloadClientBtn',
        '#deleteServerBtn',
        '#deleteClientBtn',
        '#infoClientBtn',
        '.client-card',
        '.client-discovery button',
        '.panel-actions button',
        '#manualConnectForm input',
        '#manualConnectForm button'
    ];
    
    interactiveElements.forEach(selector => {
        document.querySelectorAll(selector).forEach(element => {
            element.disabled = disable;
            if (disable) {
                element.style.opacity = '0.5';
                element.style.cursor = 'not-allowed';
            } else {
                element.style.opacity = '';
                element.style.cursor = '';
            }
        });
    });
}

</script>
{% endblock %}
